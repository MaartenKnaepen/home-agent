step: "1.3"
name: "User Profile Model"
phase: 1
goal: "Pydantic models for user profile with serialization to/from SQLite."

context:
  description: "Creating Pydantic models for user profiles that can be serialized to and from SQLite. This includes UserProfile, MediaPreferences, NotificationPrefs models and a ProfileManager class that interfaces with the database layer."
  dependencies:
    - "src/home_agent/db.py"  # Database layer for reading/writing profiles
  references:
    - "src/home_agent/db.py"  # To understand how to save/load profile data
    - "docs/LLM/api.yaml"     # To check existing interfaces
    - "docs/LLM/AGENTS.md"    # For coding conventions

tasks:
  - id: 1
    title: "Create basic Pydantic models"
    file: "src/home_agent/profile.py"
    action: "create"
    description: |
      Define the Pydantic models for user profiles: MediaPreferences, NotificationPrefs, and UserProfile.
      These models will store user preferences and settings for the home agent.
    code_snippet: |
      from pydantic import BaseModel
      from datetime import time
      from typing import Any, Dict, List, Optional
      
      class MediaPreferences(BaseModel):
          """User's media consumption preferences."""
          
          preferred_genres: List[str] = []
          preferred_quality: str = "1080p"
          preferred_language: str = "en"
          avoid_genres: List[str] = []
      
      class NotificationPrefs(BaseModel):
          """User's notification preferences."""
          
          enabled: bool = True
          quiet_hours_start: Optional[time] = None
          quiet_hours_end: Optional[time] = None
          media_requests: bool = True
          system_alerts: bool = True
      
      class UserProfile(BaseModel):
          """Complete user profile with preferences and settings."""
          
          user_id: int
          name: Optional[str] = None
          media_preferences: MediaPreferences = MediaPreferences()
          notification_preferences: NotificationPrefs = NotificationPrefs()
          notes: List[str] = []
          created_at: Optional[str] = None
          updated_at: Optional[str] = None
    tests:
      - "Create test to verify default profile has sensible defaults"
      - "Create test to verify profile serializes to JSON and deserializes back identically"
  
  - id: 2
    title: "Create ProfileManager class"
    file: "src/home_agent/profile.py"
    action: "modify"
    description: |
      Implement a ProfileManager class that handles reading/writing profiles to the SQLite database.
      This class should handle creating default profiles for new users.
    code_snippet: |
      import json
      from pathlib import Path
      from typing import Any, Dict, Optional
      
      from home_agent.db import get_profile, save_profile
      
      
      class ProfileManager:
          """Manages user profiles with async CRUD operations via db.py."""
          
          def __init__(self, db_path: str | Path, *, default_profile: Optional['UserProfile'] = None):
              self.db_path = db_path
              self.default_profile_template = default_profile or UserProfile(
                  user_id=0,  # Will be replaced with actual user_id
                  name="New User",
                  notes=["Default profile created"]
              )
          
          async def get(self, user_id: int) -> 'UserProfile':
              """Get user profile from DB, or create and persist a default one if not found."""
              profile_data = await get_profile(self.db_path, user_id=user_id)
              
              if profile_data is None:
                  # Create a default profile for new user
                  default_profile = self.default_profile_template.model_copy()
                  default_profile.user_id = user_id
                  await self.save(default_profile)
                  return default_profile
                  
              # Deserialize the profile data from JSON
              profile_data['user_id'] = user_id
              return UserProfile(**profile_data)
          
          async def save(self, profile: 'UserProfile') -> None:
              """Persist a user profile to the database, updating the updated_at timestamp."""
              from datetime import datetime
              
              profile.updated_at = datetime.now().isoformat()
              data = profile.model_dump(mode='json')
              # Remove user_id from data since it's used as the key in the database
              data.pop('user_id', None)
              
              await save_profile(self.db_path, user_id=profile.user_id, data=data)
    tests:
      - "Create test to verify ProfileManager creates default profile for unknown user"
      - "Create test to verify ProfileManager updates and persists profile fields"
  
  - id: 3
    title: "Add import linter contract"
    file: "pyproject.toml"
    action: "modify"
    description: |
      Uncomment or add the import linter contract for the profile module to ensure proper architectural boundaries.
    tests:
      - "Verify import linter passes with the new contract in place"

verification:
  - "All tasks completed successfully"
  - "verify.sh passes (ty, lint-imports, pytest)"
  - "ProfileManager correctly creates default profiles for new users"
  - "Profile serialization/deserialization works correctly"
  - "Tests pass for all profile-related functionality"