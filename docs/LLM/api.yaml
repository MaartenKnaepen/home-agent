# api.yaml — Home Agent Public API Reference
# Lists every public function, class, and tool in the project.
# LLM agents read this before implementing new code to discover reusable pieces.
# Updated after each completed step by autodev.

modules:
  # ── src/home_agent/config.py ────────────────────────────────────────────────
  - module: "src/home_agent/config.py"
    exports:
      - name: "AppConfig"
        type: "class"
        signature: "BaseSettings"
        description: "Application configuration loaded from environment variables via pydantic-settings."

      - name: "get_config"
        type: "function"
        signature: "() -> AppConfig"
        description: "Singleton accessor for the global AppConfig instance."

  # ── src/home_agent/db.py ────────────────────────────────────────────────────
  - module: "src/home_agent/db.py"
    exports:
      - name: "init_db"
        type: "function"
        signature: "async (db_path: str | Path) -> None"
        description: "Initialize the SQLite database schema (conversations and user_profiles tables)."

      - name: "save_message"
        type: "function"
        signature: "async (db_path: str | Path, *, user_id: int, role: str, content: str) -> None"
        description: "Save a conversation message to the database."

      - name: "get_history"
        type: "function"
        signature: "async (db_path: str | Path, *, user_id: int, limit: int | None = None) -> list[dict[str, str]]"
        description: "Fetch recent conversation history for a user, oldest first."

      - name: "save_profile"
        type: "function"
        signature: "async (db_path: str | Path, *, user_id: int, data: dict[str, Any]) -> None"
        description: "Persist a user profile payload (upsert by user_id)."

      - name: "get_profile"
        type: "function"
        signature: "async (db_path: str | Path, *, user_id: int) -> dict[str, Any] | None"
        description: "Retrieve a stored user profile payload, or None if missing."

  # ── src/home_agent/history.py ───────────────────────────────────────────────
  - module: "src/home_agent/history.py"
    exports:
      - name: "HistoryManager"
        type: "class"
        signature: "__init__(db_path: str | Path)"
        description: "Wraps db.py for conversation history CRUD. save_message() and get_history() delegate to db layer."

      - name: "HistoryManager.save_message"
        type: "method"
        signature: "async (*, user_id: int, role: str, content: str) -> None"
        description: "Save a message to conversation history in SQLite."

      - name: "HistoryManager.get_history"
        type: "method"
        signature: "async (*, user_id: int, limit: int | None = None) -> list[dict[str, str]]"
        description: "Fetch conversation history for a user, oldest first."

      - name: "sliding_window_processor"
        type: "function"
        signature: "(*, n: int) -> Callable[[list[ModelMessage]], list[ModelMessage]]"
        description: "Returns a PydanticAI history_processors-compatible callable that keeps only the last N message pairs."

  # ── src/home_agent/profile.py ───────────────────────────────────────────────
  - module: "src/home_agent/profile.py"
    exports:
      - name: "MediaPreferences"
        type: "class"
        signature: "BaseModel"
        description: "Genre, quality, and language preferences for media consumption."

      - name: "NotificationPrefs"
        type: "class"
        signature: "BaseModel"
        description: "Notification settings including enabled flag, quiet hours, and per-source toggles."

      - name: "UserProfile"
        type: "class"
        signature: "BaseModel"
        description: "Complete user profile with preferences, notes, statistics, and personal details."

      - name: "ProfileManager"
        type: "class"
        signature: "__init__(db_path: str | Path, *, default_profile: UserProfile | None = None)"
        description: "CRUD operations for user profiles with automatic default profile creation for new users."

      - name: "ProfileManager.get"
        type: "method"
        signature: "async (user_id: int) -> UserProfile"
        description: "Get user profile from DB, or create and persist a default one if not found."

      - name: "ProfileManager.save"
        type: "method"
        signature: "async (profile: UserProfile) -> None"
        description: "Persist a user profile to the database, updating the updated_at timestamp."

  # ── src/home_agent/bot.py ──────────────────────────────────────────────────
  - module: "src/home_agent/bot.py"
    exports:
      - name: "make_message_handler"
        type: "function"
        signature: "(config: AppConfig) -> Callable[[Update, ContextTypes.DEFAULT_TYPE], Awaitable[None]]"
        description: "Create a Telegram message handler closure that captures app config. Enforces whitelist, sends typing indicator, replies with stub."

      - name: "create_application"
        type: "function"
        signature: "(config: AppConfig) -> Application"
        description: "Build and return a configured Telegram Application with message handler wired. Does NOT start polling."

      - name: "run_bot"
        type: "function"
        signature: "(config: AppConfig) -> None"
        description: "Build the Telegram application and start polling for updates. Blocks until stopped."