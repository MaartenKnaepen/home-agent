# api.yaml — Home Agent Public API Reference
# Lists every public function, class, and tool in the project.
# LLM agents read this before implementing new code to discover reusable pieces.
# Updated after each completed step by autodev.

modules:
  # ── src/home_agent/config.py ────────────────────────────────────────────────
  - module: "src/home_agent/config.py"
    exports:
      - name: "AppConfig"
        type: "class"
        signature: "BaseSettings"
        description: "Application configuration loaded from environment variables via pydantic-settings."

      - name: "AppConfig.llm_model"
        type: "field"
        signature: "str = 'openrouter:qwen/qwq-32b:free'"
        description: "PydanticAI model string. Override via LLM_MODEL env var."

      - name: "AppConfig.mcp_port"
        type: "field"
        signature: "int = 5056"
        description: "Port number for the MCP server HTTP endpoint. Override via MCP_PORT env var."

      - name: "AppConfig.jellyseerr_4k_profile_id"
        type: "field"
        signature: "int | None = None"
        description: "Jellyseerr quality profile ID for 4K requests. None means use Jellyseerr's default profile. Must be a positive integer if set."

      - name: "AppConfig.jellyseerr_1080p_profile_id"
        type: "field"
        signature: "int | None = None"
        description: "Jellyseerr quality profile ID for 1080p requests. None means use Jellyseerr's default profile. Must be a positive integer if set."

      - name: "AppConfig.validate_profile_id"
        type: "validator"
        signature: "(cls, v: int | None) -> int | None"
        description: "Pydantic field_validator for jellyseerr_4k_profile_id and jellyseerr_1080p_profile_id. Rejects zero and negative values."

      - name: "get_config"
        type: "function"
        signature: "() -> AppConfig"
        description: "Singleton accessor for the global AppConfig instance."

  # ── src/home_agent/db.py ────────────────────────────────────────────────────
  - module: "src/home_agent/db.py"
    exports:
      - name: "init_db"
        type: "function"
        signature: "async (db_path: str | Path) -> None"
        description: "Initialize the SQLite database schema (conversations and user_profiles tables)."

      - name: "save_message"
        type: "function"
        signature: "async (db_path: str | Path, *, user_id: int, role: str, content: str) -> None"
        description: "Save a conversation message to the database."

      - name: "get_history"
        type: "function"
        signature: "async (db_path: str | Path, *, user_id: int, limit: int | None = None) -> list[dict[str, str]]"
        description: "Fetch recent conversation history for a user, oldest first."

      - name: "save_profile"
        type: "function"
        signature: "async (db_path: str | Path, *, user_id: int, data: dict[str, Any]) -> None"
        description: "Persist a user profile payload (upsert by user_id)."

      - name: "get_profile"
        type: "function"
        signature: "async (db_path: str | Path, *, user_id: int) -> dict[str, Any] | None"
        description: "Retrieve a stored user profile payload, or None if missing."

  # ── src/home_agent/history.py ───────────────────────────────────────────────
  - module: "src/home_agent/history.py"
    exports:
      - name: "HistoryManager"
        type: "class"
        signature: "__init__(db_path: str | Path)"
        description: "Wraps db.py for conversation history CRUD. save_message() and get_history() delegate to db layer."

      - name: "HistoryManager.save_message"
        type: "method"
        signature: "async (*, user_id: int, role: str, content: str) -> None"
        description: "Save a message to conversation history in SQLite."

      - name: "HistoryManager.get_history"
        type: "method"
        signature: "async (*, user_id: int, limit: int | None = None) -> list[dict[str, str]]"
        description: "Fetch conversation history for a user, oldest first."

      - name: "sliding_window_processor"
        type: "function"
        signature: "(*, n: int) -> Callable[[list[ModelMessage]], list[ModelMessage]]"
        description: "Returns a PydanticAI history_processors-compatible callable that keeps only the last N message pairs."

  # ── src/home_agent/profile.py ───────────────────────────────────────────────
  - module: "src/home_agent/profile.py"
    exports:
      - name: "MediaPreferences"
        type: "class"
        signature: "BaseModel"
        description: "User's media download preferences. Fields: movie_quality (Literal['4k', '1080p'] | None), series_quality (Literal['4k', '1080p'] | None). None means not yet asked."

      - name: "UserProfile"
        type: "class"
        signature: "BaseModel"
        description: "Complete user profile with preferences and notes. Fields: user_id, name, created_at, updated_at, reply_language (str, default 'english'), confirmation_mode (Literal['always', 'never'], default 'always'), media_preferences (MediaPreferences), notes (list[str])."

      - name: "ProfileManager"
        type: "class"
        signature: "__init__(db_path: str | Path, *, default_profile: UserProfile | None = None)"
        description: "CRUD operations for user profiles with automatic default profile creation for new users."

      - name: "resolve_language"
        type: "function"
        signature: "(language_code: str | None) -> str"
        description: "Map a Telegram language_code (ISO 639-1, e.g. 'nl', 'en-US') to a human-readable language name. Handles region suffixes and None. Falls back to 'English' for unknown codes."

      - name: "ProfileManager.get"
        type: "method"
        signature: "async (user_id: int, *, language_code: str | None = None) -> UserProfile"
        description: "Get user profile from DB, or create and persist a default one if not found. On new user creation, resolves reply_language from language_code via resolve_language(). Ignored for existing profiles."

      - name: "ProfileManager.save"
        type: "method"
        signature: "async (profile: UserProfile) -> None"
        description: "Persist a user profile to the database, updating the updated_at timestamp."

  # ── src/home_agent/tools/__init__.py ─────────────────────────────────────────
  - module: "src/home_agent/tools/__init__.py"
    exports:
      - name: "tools"
        type: "package"
        signature: ""
        description: "Agent tools package. Contains tool functions registered on the PydanticAI agent in agent.py."

  # ── src/home_agent/tools/profile_tools.py ──────────────────────────────────
  - module: "src/home_agent/tools/profile_tools.py"
    exports:
      - name: "set_movie_quality"
        type: "tool"
        signature: "async (ctx: RunContext[Any], quality: Literal['4k', '1080p']) -> str"
        description: "Store the user's preferred movie download quality. Updates profile.media_preferences.movie_quality and persists via ProfileManager."

      - name: "set_series_quality"
        type: "tool"
        signature: "async (ctx: RunContext[Any], quality: Literal['4k', '1080p']) -> str"
        description: "Store the user's preferred series download quality. Updates profile.media_preferences.series_quality and persists via ProfileManager."

      - name: "set_reply_language"
        type: "tool"
        signature: "async (ctx: RunContext[Any], language: str) -> str"
        description: "Update the language the agent uses to reply to this user. Accepts natural language names (e.g. 'Dutch', 'French'). Persists via ProfileManager."

      - name: "set_confirmation_mode"
        type: "tool"
        signature: "async (ctx: RunContext[Any], mode: Literal['always', 'never']) -> str"
        description: "Toggle whether the agent confirms before requesting media. 'always' = confirm first (default), 'never' = request immediately. Persists via ProfileManager."

  # ── src/home_agent/agent.py ─────────────────────────────────────────────────
  - module: "src/home_agent/agent.py"
    exports:
      - name: "AgentDeps"
        type: "class"
        signature: "dataclass"
        description: "Dependencies injected into the agent at runtime: config, profile_manager, history_manager, user_profile."

      - name: "create_agent"
        type: "function"
        signature: "(toolsets: list[Any] | None = None, model: str = 'openrouter:qwen/qwq-32b:free') -> Agent[AgentDeps, str]"
        description: "Factory that creates a PydanticAI agent with optional MCP toolsets, sliding-window history processor (n=20), static system prompt (## Media Requests with SEARCH→DISAMBIGUATE→QUALITY→CONFIRM flow, ## Language, ## Preferences), dynamic system prompt (## Current User Context), update_user_note tool, and 4 profile tools."

      - name: "inject_user_profile"
        type: "function"
        signature: "async (ctx: RunContext[AgentDeps]) -> str"
        description: "Dynamic system prompt that injects '## Current User Context' block with name, reply_language, confirmation_mode, movie/series quality (or 'NOT SET'), and notes. Registered inside create_agent()."

      - name: "update_user_note"
        type: "tool"
        signature: "async (ctx: RunContext[AgentDeps], note: str) -> str"
        description: "Agent tool that appends a note to the user's profile and persists it via ProfileManager. Registered inside create_agent()."

      - name: "get_agent_toolsets"
        type: "function"
        signature: "(registry: MCPRegistry) -> list[Any]"
        description: "Get MCP toolsets from the registry for agent construction. Thin wrapper over registry.get_toolsets()."

  # ── src/home_agent/bot.py ──────────────────────────────────────────────────
  - module: "src/home_agent/bot.py"
    exports:
      - name: "_error_handler"
        type: "function"
        signature: "async (update: object, context: ContextTypes.DEFAULT_TYPE) -> None"
        description: "Telegram error handler that logs all unhandled exceptions. Registered on the Application via add_error_handler()."

      - name: "make_message_handler"
        type: "function"
        signature: "(config: AppConfig, profile_manager: ProfileManager, history_manager: HistoryManager, agent: Agent[AgentDeps, str]) -> Callable[[Update, ContextTypes.DEFAULT_TYPE], Awaitable[None]]"
        description: "Create a Telegram message handler closure. Enforces whitelist, sends typing indicator, calls agent.run() with try/except, guards against empty reply, persists conversation history."

      - name: "create_application"
        type: "function"
        signature: "(config: AppConfig, profile_manager: ProfileManager, history_manager: HistoryManager, agent: Agent[AgentDeps, str]) -> Application"
        description: "Build and return a configured Telegram Application with message handler and error handler wired. Does NOT start polling."

      - name: "run_bot"
        type: "function"
        signature: "(config: AppConfig, profile_manager: ProfileManager, history_manager: HistoryManager, agent: Agent[AgentDeps, str]) -> None"
        description: "Build the Telegram application and start polling for updates. Blocks until stopped."

  # ── src/home_agent/main.py ──────────────────────────────────────────────────
  - module: "src/home_agent/main.py"
    exports:
      - name: "setup_logging"
        type: "function"
        signature: "(log_level: str) -> None"
        description: "Configure root logger with the given level string (e.g. 'INFO', 'DEBUG')."

      - name: "_async_main"
        type: "function"
        signature: "async () -> None"
        description: "Async entry point. Initializes all components, opens MCP connections via async with agent:, starts Telegram bot polling. Blocks until interrupted."

      - name: "main"
        type: "function"
        signature: "() -> None"
        description: "Synchronous entry point. Calls asyncio.run(_async_main()) with KeyboardInterrupt handling."

  # ── Dockerfile ───────────────────────────────────────────────────────────────
  - module: "Dockerfile"
    exports:
      - name: "build"
        type: "stage"
        signature: "FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim"
        description: "Build stage: installs dependencies via uv sync --frozen --no-dev into .venv."

      - name: "runtime"
        type: "stage"
        signature: "FROM python:3.12-slim-bookworm"
        description: "Runtime stage: non-root appuser, copies .venv and src/ from build stage. Entry point: python -m home_agent.main. Health check via pgrep."

  # ── deployment/docker-compose.yml ────────────────────────────────────────────
  - module: "deployment/docker-compose.yml"
    exports:
      - name: "home-agent"
        type: "service"
        signature: "build: context: .., dockerfile: Dockerfile"
        description: "Home agent bot container. Loads .env, sets MCP_HOST=jellyseerr-mcp for Docker networking, mounts home-agent-data volume at /app/data, depends on healthy jellyseerr-mcp."

      - name: "jellyseerr-mcp"
        type: "service"
        signature: "image: ghcr.io/aserper/jellyseerr-mcp:latest"
        description: "Community Jellyseerr MCP server with volume-mounted patched main.py (binds 0.0.0.0, disables DNS rebinding). SSE transport at /sse. Config via JELLYSEERR_URL, JELLYSEERR_API_KEY, MCP_PORT env vars. Health check via Python socket connect."

  # ── src/home_agent/mcp/servers.py ───────────────────────────────────────
  - module: "src/home_agent/mcp/servers.py"
    exports:
      - name: "ServerConfig"
        type: "dataclass"
        signature: "name: str, url: str, enabled: bool = True"
        description: "Configuration for an MCP server with name, URL, and enabled state."

      - name: "get_jellyseerr_config"
        type: "function"
        signature: "(mcp_port: int = 5056) -> ServerConfig"
        description: "Create Jellyseerr MCP server configuration. Uses MCP_HOST env var (default 'localhost') for host and mcp_port for port. URL: http://{mcp_host}:{port}/sse."

  # ── src/home_agent/mcp/registry.py ──────────────────────────────────────
  - module: "src/home_agent/mcp/registry.py"
    exports:
      - name: "MCPRegistry"
        type: "class"
        signature: "__init__() -> None"
        description: "Registry for MCP servers. Manages configurations and creates FastMCPToolset instances."

      - name: "MCPRegistry.register"
        type: "method"
        signature: "(config: ServerConfig) -> None"
        description: "Register an MCP server configuration."

      - name: "MCPRegistry.get_toolsets"
        type: "method"
        signature: "() -> list[FastMCPToolset]"
        description: "Create FastMCPToolset instances for all enabled servers."

      - name: "MCPRegistry.get_tool_names"
        type: "method"
        signature: "() -> list[str]"
        description: "Get list of enabled server names."

  # ── mcp_servers/jellyseerr/main.py ─────────────────────────────────────────
  - module: "mcp_servers/jellyseerr/main.py"
    exports:
      - name: "patched entrypoint"
        type: "script"
        signature: "__main__ with --transport sse"
        description: "Volume-mounted replacement for jellyseerr-mcp container's main.py. Binds uvicorn to 0.0.0.0 (not 127.0.0.1) and disables MCP DNS rebinding protection so Docker service-name Host headers are accepted."